# Cross-platform Makefile for Python projects

PY=python3
VENV=.venv
OUTPUT=outputs

# Detect OS
ifeq ($(OS),Windows_NT)
    PYBIN=$(VENV)/Scripts/python.exe
    MKDIR=if not exist $(OUTPUT) mkdir $(OUTPUT)
    RM=rd /s /q $(VENV) & rd /s /q $(OUTPUT)
else
    PYBIN=$(VENV)/bin/python
    MKDIR=mkdir -p $(OUTPUT)
    RM=rm -rf $(VENV) $(OUTPUT)
endif

.PHONY: setup install build test run-all clean preprocess train evaluate visualize

# Setup virtual environment
setup:
	$(PY) -m venv $(VENV)
	$(PYBIN) -m pip install --upgrade pip setuptools wheel nbconvert
	make install

# Install dependencies
install:
	$(PYBIN) -m pip install -r requirements.txt

# Build step (placeholder)
build:
	@echo "No compiled componentsâ€”skipping build step."

# Run all steps
run-all: preprocess train evaluate # visualize

# Preprocess notebooks
preprocess:
	$(MKDIR)
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/01_EDA.ipynb --output $(OUTPUT)/01_EDA_out.ipynb
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/02_Data_cleaning.ipynb --output $(OUTPUT)/02_Data_cleaning_out.ipynb

# Feature engineering and training
train:
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/03_Feature_eng.ipynb --output $(OUTPUT)/03_Feature_eng_out.ipynb
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/04_model.ipynb --output $(OUTPUT)/04_model_out.ipynb

# Evaluate model
evaluate:
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/05_Test_evaluation.ipynb --output $(OUTPUT)/05_Test_evaluation_out.ipynb

# Visualize (optional)
visualize:
	$(PYBIN) -m nbconvert --to notebook --execute notebooks/visualize.ipynb --output $(OUTPUT)/visualize_out.ipynb

# Clean virtual environment and outputs
clean:
	$(RM)

